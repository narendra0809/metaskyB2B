<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Send USDT (TRC20) — Tron dApp</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    .card { border: 1px solid #ddd; padding: 16px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
    input, button { padding: 8px; font-size: 16px; }
    input { width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    button { cursor: pointer; }
    pre { background:#f8f8f8; padding: 12px; border-radius: 6px; overflow:auto; }
  </style>
</head>
<body>
  <h2>Send USDT (TRC20) on Tron</h2>
  <div class="card">
    <div id="walletStatus">Wallet: <strong id="walletText">Not connected</strong></div>
    <p>
      <button id="connectBtn">Connect Wallet</button>
    </p>

    <form id="sendForm">
      <label>Sender address (from wallet) — auto-filled:</label>
      <input id="fromAddress" readonly />

      <label>Recipient address (TRON address, starts with T)</label>
      <input id="toAddress" placeholder="T..." required />

      <label>Amount (USDT)</label>
      <input id="amount" placeholder="e.g. 12.34" required />

      <p>
        <button type="submit">Send USDT</button>
      </p>
    </form>

    <div>
      <strong>Logs / Result</strong>
      <pre id="log">Ready.</pre>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
<script>
  // If wallet injected (TronLink), use it. Otherwise create a fallback TronWeb using TronGrid.
  const TRONGRID_HOST = 'https://api.trongrid.io';
  const TRONGRID_API_KEY = '327a9389-0a49-42b0-967f-992bfaf5a7dd'; // optional but recommended

  const fallbackTronWeb = new TronWeb({
    fullHost: TRONGRID_HOST,
    headers: TRONGRID_API_KEY ? { "TRON-PRO-API-KEY": TRONGRID_API_KEY } : {}
  });

  // Use injected provider if present, else fallback
  const tronWeb = window.tronWeb && window.tronWeb.ready ? window.tronWeb : fallbackTronWeb;

  // now use tronWeb.contract().at(...)
</script>

  <!-- TronWeb CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
  <script>
    (function() {
      // Official USDT TRC20 contract on Tron mainnet:
      // TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t (decimals = 6).
      // Source: Tron / Tether docs (verify on Tronscan). 
      const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
      const USDT_DECIMALS = 6;

      const connectBtn = document.getElementById('connectBtn');
      const walletText = document.getElementById('walletText');
      const fromAddressInput = document.getElementById('fromAddress');
      const logEl = document.getElementById('log');
      const form = document.getElementById('sendForm');

      function log(msg) {
        const ts = new Date().toLocaleTimeString();
        logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
      }

      // Utility: convert decimal USDT amount to integer according to decimals
      function toTokenInteger(amountStr, decimals) {
        // Work with strings to avoid floating imprecision
        if (!/^\d+(\.\d+)?$/.test(amountStr.trim())) throw new Error("Invalid amount format");
        const parts = amountStr.split('.');
        const whole = parts[0];
        const frac = parts[1] || '';
        if (frac.length > decimals) {
          // truncate (or you may want to reject)
          const truncated = frac.slice(0, decimals);
          return BigInt(whole + truncated.padEnd(decimals, '0'));
        } else {
          return BigInt(whole + frac.padEnd(decimals, '0'));
        }
      }

      // Detect injected tronWeb (TronLink) and connect
      async function tryAutoConnect() {
        if (window.tronWeb && window.tronWeb.defaultAddress && window.tronWeb.defaultAddress.base58) {
          walletText.textContent = window.tronWeb.defaultAddress.base58;
          fromAddressInput.value = window.tronWeb.defaultAddress.base58;
          log('Detected injected tronWeb (wallet present).');
          return true;
        }
        // Some wallets inject asynchronously; wait briefly
        let attempts = 0;
        while(attempts < 10 && (!window.tronWeb || !window.tronWeb.ready)) {
          await new Promise(r => setTimeout(r, 300));
          attempts++;
        }
        if (window.tronWeb && window.tronWeb.defaultAddress && window.tronWeb.defaultAddress.base58) {
          walletText.textContent = window.tronWeb.defaultAddress.base58;
          fromAddressInput.value = window.tronWeb.defaultAddress.base58;
          log('Connected to injected tronWeb.');
          return true;
        }
        log('No injected tronWeb provider found. Use TronLink or a compatible wallet.');
        return false;
      }

      // Request wallet connection (TronLink provides a requestAddress method)
      async function requestWalletConnect() {
        try {
          if (window.tronWeb && window.tronWeb.request) {
            // some providers follow eth-like API
            await window.tronWeb.request({ method: 'tron_requestAccounts' }).catch(()=>{});
          }
          if (window.tronLink && window.tronLink.request) {
            await window.tronLink.request({ method: 'tron_requestAccounts' }).catch(()=>{});
          }
          // For TronLink typically just reading window.tronWeb.defaultAddress triggers permission popup.
          if (window.tronWeb && window.tronWeb.defaultAddress && window.tronWeb.defaultAddress.base58) {
            walletText.textContent = window.tronWeb.defaultAddress.base58;
            fromAddressInput.value = window.tronWeb.defaultAddress.base58;
            log('Wallet connected: ' + window.tronWeb.defaultAddress.base58);
            return;
          }
          // If still not connected, ask user to open TronLink / wallet and connect
          alert('Please open TronLink (or compatible Tron wallet) and connect / enable it for this site, then click Connect again.');
        } catch (err) {
          console.error(err);
          log('Error requesting wallet connection: ' + (err.message || err));
        }
      }

      // Send USDT (TRC20) using tronWeb (calls contract.transfer)
      async function sendUsdt(from, to, amountStr) {
        if (!window.tronWeb || !window.tronWeb.defaultAddress || !window.tronWeb.defaultAddress.base58) {
          throw new Error('Wallet not connected');
        }
        const tronWeb = window.tronWeb;

        // Validate recipient (very basic check)
        if (!to || !to.startsWith('T') || to.length < 25) {
          throw new Error('Invalid TRON recipient address');
        }

        // Convert amount
        const amountInt = toTokenInteger(amountStr, USDT_DECIMALS); // BigInt
        log(`Converting ${amountStr} → integer: ${amountInt.toString()} (decimals ${USDT_DECIMALS})`);

        // get contract instance
        log('Obtaining USDT contract instance...');
        const contract = await tronWeb.contract().at(USDT_CONTRACT);

        // Call transfer: for TRC20: transfer(address,uint256)
        // Some TRC20 tokens (including USDT old versions) may not return boolean — tronWeb handles .send()
        log('Triggering transfer via wallet. You will be asked to confirm in your wallet.');
        const tx = await contract.transfer(to, amountInt.toString()).send({
          feeLimit: 1_000_000_000 // set high enough feeLimit (1 TRX = 1e6 SUN). adjust as needed
        });
        log('Transaction broadcasted. Txid: ' + tx);
        return tx;
      }

      // Initialize
      (async function init() {
        await tryAutoConnect();
      })();

      connectBtn.addEventListener('click', async () => {
        await requestWalletConnect();
        await tryAutoConnect();
      });

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const from = fromAddressInput.value.trim();
        const to = document.getElementById('toAddress').value.trim();
        const amt = document.getElementById('amount').value.trim();

        try {
          if (!from) throw new Error('Connect wallet first.');
          log(`Preparing to send ${amt} USDT from ${from} to ${to}`);
          // confirm with user
          if (!confirm(`Send ${amt} USDT to ${to}?`)) {
            log('User cancelled.');
            return;
          }
          const txid = await sendUsdt(from, to, amt);
          log('SUCCESS — txid: ' + txid);
          alert('Sent! Txid: ' + txid);
        } catch (err) {
          console.error(err);
          log('Error: ' + (err.message || JSON.stringify(err)));
          alert('Error: ' + (err.message || JSON.stringify(err)));
        }
      });
    })();
  </script>
</body>
</html>
